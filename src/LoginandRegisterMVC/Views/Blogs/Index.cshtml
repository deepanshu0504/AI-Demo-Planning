@model LoginandRegisterMVC.Models.BlogListViewModel

@{
    ViewData["Title"] = "All Blogs";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-4">All Blogs</h1>
            <p class="lead text-muted">Discover and read amazing content from our community</p>
        </div>
        <div class="col-md-4 text-right">
            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                <a asp-action="Create" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus"></i> Create Blog
                </a>
            }
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <!-- Search Bar -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="input-group input-group-lg">
                        <input type="text" 
                               id="searchInput" 
                               class="form-control" 
                               placeholder="Search blogs by title, content, or author..." 
                               value="">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch" style="display:none;">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="btn btn-primary" type="button" id="searchButton">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Row -->
            <div class="row">
                <!-- Category Filter -->
                <div class="col-md-3 col-sm-6 mb-2">
                    <select id="categoryFilter" class="form-control">
                        <option value="">All Categories</option>
                        @if (ViewBag.Categories != null)
                        {
                            @foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.CategoryId">@category.Name</option>
                            }
                        }
                    </select>
                </div>

                <!-- Author Filter -->
                <div class="col-md-3 col-sm-6 mb-2">
                    <select id="authorFilter" class="form-control">
                        <option value="">All Authors</option>
                        @if (ViewBag.Authors != null)
                        {
                            @foreach (var author in ViewBag.Authors)
                            {
                                <option value="@author.UserId">@author.Username</option>
                            }
                        }
                    </select>
                </div>

                <!-- Date From -->
                <div class="col-md-2 col-sm-6 mb-2">
                    <input type="date" id="startDate" class="form-control" placeholder="From Date">
                </div>

                <!-- Date To -->
                <div class="col-md-2 col-sm-6 mb-2">
                    <input type="date" id="endDate" class="form-control" placeholder="To Date">
                </div>

                <!-- Sort -->
                <div class="col-md-2 col-sm-6 mb-2">
                    <select id="sortBy" class="form-control">
                        <option value="recent">Most Recent</option>
                        <option value="oldest">Oldest First</option>
                        <option value="views">Most Viewed</option>
                        <option value="a-z">Title (A-Z)</option>
                        <option value="z-a">Title (Z-A)</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters and Clear Button -->
            <div class="row mt-3" id="activeFiltersRow" style="display:none;">
                <div class="col-md-12">
                    <div class="d-flex align-items-center flex-wrap">
                        <strong class="mr-2">Active Filters:</strong>
                        <div id="activeFilters" class="d-inline-flex flex-wrap"></div>
                        <button class="btn btn-sm btn-outline-danger ml-auto" id="clearAllFilters">
                            <i class="fas fa-times-circle"></i> Clear All Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Count and Loading -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <span id="resultsCount" class="text-muted">
                Showing @Model.TotalCount @(Model.TotalCount == 1 ? "result" : "results")
            </span>
        </div>
        <div id="loadingIndicator" style="display:none;">
            <span class="text-primary">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </span>
        </div>
    </div>

    <!-- Blog Cards Container -->
    <div id="blogsContainer">
    @if (!Model.Blogs.Any())
    {
        <div class="empty-state text-center py-5">
            <i class="fas fa-newspaper fa-5x text-muted mb-3"></i>
            <h3>No blogs available yet</h3>
            <p class="text-muted">Be the first to create one!</p>
            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                <a asp-action="Create" class="btn btn-primary btn-lg mt-3">
                    <i class="fas fa-plus"></i> Create Your First Blog
                </a>
            }
            else
            {
                <a asp-controller="Users" asp-action="Login" class="btn btn-primary btn-lg mt-3">
                    Login to Create Blog
                </a>
            }
        </div>
    }
    else
    {
        <!-- Blog Cards Grid -->
        <div class="row">
            @foreach (var blog in Model.Blogs)
            {
                <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                    <div class="blog-card card h-100 shadow-sm">
                        <!-- Featured Image -->
                        <div class="blog-card-image">
                            <img src="~/uploads/blogs/@blog.FeaturedImage" 
                                 class="card-img-top" 
                                 alt="@blog.Title"
                                 style="height: 200px; object-fit: cover;">
                        </div>

                        <div class="card-body d-flex flex-column">
                            <!-- Category Badge -->
                            @if (blog.Category != null)
                            {
                                <span class="badge badge-primary mb-2">@blog.Category.Name</span>
                            }

                            <!-- Blog Title -->
                            <h5 class="card-title font-weight-bold">
                                @if (blog.Title.Length > 60)
                                {
                                    @(blog.Title.Substring(0, 60) + "...")
                                }
                                else
                                {
                                    @blog.Title
                                }
                            </h5>

                            <!-- Blog Excerpt -->
                            <p class="card-text text-muted">
                                @if (!string.IsNullOrEmpty(blog.Excerpt))
                                {
                                    @blog.Excerpt
                                }
                                else
                                {
                                    @(blog.Content.Length > 150 ? blog.Content.Substring(0, 150) + "..." : blog.Content)
                                }
                            </p>

                            <!-- Spacer to push footer to bottom -->
                            <div class="mt-auto">
                                <!-- Author and Metadata -->
                                <div class="blog-meta d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> 
                                        @if (blog.Author != null)
                                        {
                                            @blog.Author.Username
                                        }
                                        else
                                        {
                                            <text>Unknown</text>
                                        }
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye"></i> @blog.ViewCount
                                    </small>
                                </div>

                                <!-- Published Date -->
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar"></i> 
                                        @(blog.PublishedDate?.ToString("MMM dd, yyyy") ?? blog.CreatedDate.ToString("MMM dd, yyyy"))
                                    </small>
                                </div>

                                <!-- Last Updated (if different from published) -->
                                @if (blog.LastUpdatedDate > (blog.PublishedDate ?? blog.CreatedDate).AddMinutes(1))
                                {
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-edit"></i> 
                                            Last updated: @blog.LastUpdatedDate.ToString("MMM dd, yyyy HH:mm")
                                        </small>
                                    </div>
                                }

                                <!-- Read More Button -->
                                <a asp-action="Details" asp-route-id="@blog.BlogId" class="btn btn-outline-primary btn-block">
                                    <i class="fas fa-book-open"></i> Read More
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    </div>
    <!-- End Blog Cards Container -->

    <!-- Pagination -->
    <div id="paginationContainer">
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Blog pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    <!-- Previous Button -->
                    <li class="page-item @(!Model.HasPrevious ? "disabled" : "")">
                        <a class="page-link" 
                           asp-action="Index" 
                           asp-route-pageNumber="@(Model.CurrentPage - 1)"
                           aria-label="Previous">
                            <span aria-hidden="true">&laquo; Previous</span>
                        </a>
                    </li>

                    <!-- Page Numbers -->
                    @{
                        var startPage = Math.Max(1, Model.CurrentPage - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                    }

                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-action="Index" asp-route-pageNumber="1">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }

                    @for (var i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-action="Index" asp-route-pageNumber="@i">@i</a>
                        </li>
                    }

                    @if (endPage < Model.TotalPages)
                    {
                        @if (endPage < Model.TotalPages - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item">
                            <a class="page-link" asp-action="Index" asp-route-pageNumber="@Model.TotalPages">@Model.TotalPages</a>
                        </li>
                    }

                    <!-- Next Button -->
                    <li class="page-item @(!Model.HasNext ? "disabled" : "")">
                        <a class="page-link" 
                           asp-action="Index" 
                           asp-route-pageNumber="@(Model.CurrentPage + 1)"
                           aria-label="Next">
                            <span aria-hidden="true">Next &raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Results Info -->
            <div class="text-center text-muted mb-4">
                <small>
                    Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) 
                    to @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalCount)) 
                    of @Model.TotalCount blogs
                </small>
            </div>
        }
    </div>
    <!-- End Pagination Container -->
</div>

@section Scripts {
    <script>
        // Search and Filter JavaScript with Debouncing
        $(document).ready(function() {
            let searchTimeout;
            const debounceDelay = 500; // 500ms debounce
            let currentPage = 1;

            // Get URL parameters on page load
            function getUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                return {
                    search: urlParams.get('search') || '',
                    categoryId: urlParams.get('categoryId') || '',
                    authorId: urlParams.get('authorId') || '',
                    startDate: urlParams.get('startDate') || '',
                    endDate: urlParams.get('endDate') || '',
                    sortBy: urlParams.get('sortBy') || 'recent',
                    pageNumber: parseInt(urlParams.get('pageNumber')) || 1
                };
            }

            // Initialize filters from URL
            function initializeFiltersFromUrl() {
                const params = getUrlParams();
                $('#searchInput').val(params.search);
                $('#categoryFilter').val(params.categoryId);
                $('#authorFilter').val(params.authorId);
                $('#startDate').val(params.startDate);
                $('#endDate').val(params.endDate);
                $('#sortBy').val(params.sortBy);
                currentPage = params.pageNumber;

                if (params.search) {
                    $('#clearSearch').show();
                }

                updateActiveFilters();
            }

            // Update URL without page reload
            function updateUrl(params) {
                const url = new URL(window.location);
                Object.keys(params).forEach(key => {
                    if (params[key]) {
                        url.searchParams.set(key, params[key]);
                    } else {
                        url.searchParams.delete(key);
                    }
                });
                window.history.pushState({}, '', url);
            }

            // Update active filters display
            function updateActiveFilters() {
                const search = $('#searchInput').val();
                const categoryId = $('#categoryFilter').val();
                const categoryText = $('#categoryFilter option:selected').text();
                const authorId = $('#authorFilter').val();
                const authorText = $('#authorFilter option:selected').text();
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();
                const sortBy = $('#sortBy').val();

                let html = '';
                let hasFilters = false;

                if (search) {
                    html += `<span class="badge badge-primary mr-2 mb-2">Search: "${search}" <i class="fas fa-times ml-1" data-filter="search" style="cursor:pointer;"></i></span>`;
                    hasFilters = true;
                }

                if (categoryId) {
                    html += `<span class="badge badge-info mr-2 mb-2">Category: ${categoryText} <i class="fas fa-times ml-1" data-filter="category" style="cursor:pointer;"></i></span>`;
                    hasFilters = true;
                }

                if (authorId) {
                    html += `<span class="badge badge-success mr-2 mb-2">Author: ${authorText} <i class="fas fa-times ml-1" data-filter="author" style="cursor:pointer;"></i></span>`;
                    hasFilters = true;
                }

                if (startDate || endDate) {
                    const dateText = startDate && endDate ? `${startDate} to ${endDate}` : 
                                    startDate ? `From ${startDate}` : `To ${endDate}`;
                    html += `<span class="badge badge-warning mr-2 mb-2">Date: ${dateText} <i class="fas fa-times ml-1" data-filter="date" style="cursor:pointer;"></i></span>`;
                    hasFilters = true;
                }

                if (sortBy && sortBy !== 'recent') {
                    const sortText = $('#sortBy option:selected').text();
                    html += `<span class="badge badge-secondary mr-2 mb-2">Sort: ${sortText} <i class="fas fa-times ml-1" data-filter="sort" style="cursor:pointer;"></i></span>`;
                    hasFilters = true;
                }

                $('#activeFilters').html(html);
                $('#activeFiltersRow').toggle(hasFilters);
            }

            // Remove individual filter
            $(document).on('click', '#activeFilters .fa-times', function() {
                const filterType = $(this).data('filter');
                
                switch(filterType) {
                    case 'search':
                        $('#searchInput').val('');
                        $('#clearSearch').hide();
                        break;
                    case 'category':
                        $('#categoryFilter').val('');
                        break;
                    case 'author':
                        $('#authorFilter').val('');
                        break;
                    case 'date':
                        $('#startDate').val('');
                        $('#endDate').val('');
                        break;
                    case 'sort':
                        $('#sortBy').val('recent');
                        break;
                }
                
                performSearch(1);
            });

            // Perform AJAX search
            function performSearch(page = 1) {
                currentPage = page;
                const params = {
                    pageNumber: page,
                    search: $('#searchInput').val(),
                    categoryId: $('#categoryFilter').val(),
                    authorId: $('#authorFilter').val(),
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val(),
                    sortBy: $('#sortBy').val()
                };

                // Update URL
                updateUrl(params);

                // Update active filters
                updateActiveFilters();

                // Show loading indicator
                $('#loadingIndicator').show();

                $.ajax({
                    url: '@Url.Action("Index", "Blogs")',
                    type: 'GET',
                    data: params,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            renderBlogs(response.blogs);
                            renderPagination(response.totalPages, response.currentPage, response.totalCount);
                            updateResultsCount(response.totalCount);
                        }
                    },
                    error: function() {
                        alert('Error loading blogs. Please try again.');
                    },
                    complete: function() {
                        $('#loadingIndicator').hide();
                    }
                });
            }

            // Render blogs
            function renderBlogs(blogs) {
                if (blogs.length === 0) {
                    $('#blogsContainer').html(`
                        <div class="empty-state text-center py-5">
                            <i class="fas fa-search fa-5x text-muted mb-3"></i>
                            <h3>No blogs found</h3>
                            <p class="text-muted">Try adjusting your search or filters</p>
                        </div>
                    `);
                    return;
                }

                let html = '<div class="row">';
                blogs.forEach(function(blog) {
                    html += `
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="blog-card card h-100 shadow-sm">
                                <div class="blog-card-image">
                                    <img src="/uploads/blogs/${blog.featuredImage}" 
                                         class="card-img-top" 
                                         alt="${blog.title}"
                                         style="height: 200px; object-fit: cover;">
                                </div>
                                <div class="card-body d-flex flex-column">
                                    ${blog.categoryName ? `<span class="badge badge-primary mb-2">${blog.categoryName}</span>` : ''}
                                    <h5 class="card-title font-weight-bold">
                                        ${blog.title.length > 60 ? blog.title.substring(0, 60) + '...' : blog.title}
                                    </h5>
                                    <p class="card-text text-muted">${blog.excerpt}</p>
                                    <div class="mt-auto">
                                        <div class="blog-meta d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-user"></i> ${blog.authorName || 'Unknown'}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-eye"></i> ${blog.viewCount}
                                            </small>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> ${blog.publishedDate}
                                            </small>
                                        </div>
                                        <a href="/Blogs/Details/${blog.blogId}" class="btn btn-outline-primary btn-block">
                                            <i class="fas fa-book-open"></i> Read More
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                $('#blogsContainer').html(html);

                // Re-apply hover effects
                $('.blog-card').hover(
                    function() {
                        $(this).addClass('shadow-lg').css('transform', 'translateY(-5px)');
                    },
                    function() {
                        $(this).removeClass('shadow-lg').css('transform', 'translateY(0)');
                    }
                );
            }

            // Render pagination
            function renderPagination(totalPages, currentPage, totalCount) {
                if (totalPages <= 1) {
                    $('#paginationContainer').html('');
                    return;
                }

                let html = '<nav aria-label="Blog pagination" class="mt-4"><ul class="pagination justify-content-center">';
                
                // Previous button
                html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                                <span aria-hidden="true">&laquo; Previous</span>
                            </a>
                        </li>`;

                // Page numbers
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);

                if (startPage > 1) {
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                    if (startPage > 2) {
                        html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>`;
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
                }

                // Next button
                html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                                <span aria-hidden="true">Next &raquo;</span>
                            </a>
                        </li>`;

                html += '</ul></nav>';

                // Results info
                const from = (currentPage - 1) * 9 + 1;
                const to = Math.min(currentPage * 9, totalCount);
                html += `<div class="text-center text-muted mb-4">
                            <small>Showing ${from} to ${to} of ${totalCount} blogs</small>
                        </div>`;

                $('#paginationContainer').html(html);
            }

            // Update results count
            function updateResultsCount(count) {
                $('#resultsCount').text(`Showing ${count} ${count === 1 ? 'result' : 'results'}`);
            }

            // Search input with debouncing
            $('#searchInput').on('input', function() {
                const value = $(this).val();
                $('#clearSearch').toggle(value.length > 0);

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    performSearch(1);
                }, debounceDelay);
            });

            // Clear search button
            $('#clearSearch').on('click', function() {
                $('#searchInput').val('');
                $(this).hide();
                performSearch(1);
            });

            // Search button
            $('#searchButton').on('click', function() {
                performSearch(1);
            });

            // Filter changes
            $('#categoryFilter, #authorFilter, #sortBy').on('change', function() {
                performSearch(1);
            });

            $('#startDate, #endDate').on('change', function() {
                performSearch(1);
            });

            // Clear all filters
            $('#clearAllFilters').on('click', function() {
                $('#searchInput').val('');
                $('#categoryFilter').val('');
                $('#authorFilter').val('');
                $('#startDate').val('');
                $('#endDate').val('');
                $('#sortBy').val('recent');
                $('#clearSearch').hide();
                performSearch(1);
            });

            // Pagination click handler
            $(document).on('click', '#paginationContainer a.page-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && page > 0) {
                    performSearch(page);
                    $('html, body').animate({ scrollTop: 0 }, 'fast');
                }
            });

            // Initialize from URL
            initializeFiltersFromUrl();
        });
    </script>
}

