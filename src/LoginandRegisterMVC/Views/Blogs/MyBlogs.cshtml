@model LoginandRegisterMVC.Models.MyBlogsViewModel

@{
    ViewData["Title"] = "My Blogs";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <h2>My Blogs</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @(Model.Filter == "all" ? "active" : "")" asp-action="MyBlogs" asp-route-filter="all" asp-route-sortBy="@Model.SortBy">
                All <span class="badge badge-secondary">@Model.TotalCount</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.Filter == "published" ? "active" : "")" asp-action="MyBlogs" asp-route-filter="published" asp-route-sortBy="@Model.SortBy">
                Published <span class="badge badge-success">@Model.PublishedCount</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.Filter == "drafts" ? "active" : "")" asp-action="MyBlogs" asp-route-filter="drafts" asp-route-sortBy="@Model.SortBy">
                Drafts <span class="badge badge-warning">@Model.DraftCount</span>
            </a>
        </li>
    </ul>

    @if (!Model.Blogs.Any())
    {
        <div class="alert alert-info">
            <h4>You haven't created any blogs yet. Start writing!</h4>
            <a asp-action="Create" class="btn btn-primary mt-2">Create Your First Blog</a>
        </div>
    }
    else
    {
        <div class="mb-3">
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New Blog
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Last Updated</th>
                        <th>Views</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var blog in Model.Blogs)
                    {
                        <tr>
                            <td>
                                <img src="~/uploads/blogs/@blog.FeaturedImage" alt="@blog.Title" style="width: 60px; height: 60px; object-fit: cover;" />
                            </td>
                            <td>
                                <strong>@blog.Title</strong>
                                @if (blog.Category != null)
                                {
                                    <br /><small class="text-muted">@blog.Category.Name</small>
                                }
                            </td>
                            <td>
                                @if (blog.Status == LoginandRegisterMVC.Models.BlogStatus.Published)
                                {
                                    <span class="badge badge-success">Published</span>
                                }
                                else
                                {
                                    <span class="badge badge-warning">Draft</span>
                                }
                            </td>
                            <td>@blog.CreatedDate.ToString("MMM dd, yyyy")</td>
                            <td>@blog.LastUpdatedDate.ToString("MMM dd, yyyy HH:mm")</td>
                            <td>@blog.ViewCount</td>
                            <td>
                                <a asp-action="Details" asp-route-id="@blog.BlogId" class="btn btn-sm btn-info" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@blog.BlogId" class="btn btn-sm btn-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-danger delete-blog-btn" data-blog-id="@blog.BlogId" data-blog-title="@blog.Title" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteBlogModal" tabindex="-1" role="dialog" aria-labelledby="deleteBlogModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteBlogModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Delete
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this blog post?</p>
                <p><strong id="blogTitleToDelete"></strong></p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var blogIdToDelete = 0;

            // Delete button click handler
            $('.delete-blog-btn').on('click', function () {
                blogIdToDelete = $(this).data('blog-id');
                var blogTitle = $(this).data('blog-title');
                $('#blogTitleToDelete').text(blogTitle);
                $('#deleteBlogModal').modal('show');
            });

            // Confirm delete button click handler
            $('#confirmDeleteBtn').on('click', function () {
                if (blogIdToDelete > 0) {
                    $.ajax({
                        url: '@Url.Action("Delete", "Blogs")/' + blogIdToDelete,
                        type: 'POST',
                        data: {
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                $('#deleteBlogModal').modal('hide');
                                location.reload();
                            } else {
                                alert('Error: ' + response.message);
                            }
                        },
                        error: function () {
                            alert('An error occurred while deleting the blog.');
                        }
                    });
                }
            });
        });
    </script>
}

@Html.AntiForgeryToken()

